/*
 *  This file is part of MxUpdate <http://www.mxupdate.org>.
 *
 *  MxUpdate is a deployment tool for a PLM platform to handle
 *  administration objects as single update files (configuration item).
 *
 *  Copyright (C) 2008-2016 The MxUpdate Team - All Rights Reserved
 *
 *  You may use, distribute and modify MxUpdate under the terms of the
 *  MxUpdate license. You should have received a copy of the MxUpdate
 *  license with this file. If not, please write to <info@mxupdate.org>,
 *  or visit <www.mxupdate.org>.
 *
 */

options {
    JDK_VERSION = "1.6";
    STATIC = false;
    ERROR_REPORTING = true;
    USER_TOKEN_MANAGER = false;
    GENERATE_BOILERPLATE = false;
}
PARSER_BEGIN(PackageParser)
package org.mxupdate.update.system;

import java.lang.reflect.InvocationTargetException;

import org.mxupdate.update.system.PackageCI_mxJPO.MemberRef;
import org.mxupdate.update.util.AbstractParser_mxJPO;
import org.mxupdate.update.util.AbstractParser_mxJPO.ParseException;
import org.mxupdate.update.util.AbstractParser_mxJPO.SimpleCharStream;
import org.mxupdate.update.util.AbstractParser_mxJPO.Token;
import org.mxupdate.update.util.AbstractParser_mxJPO.TokenMgrError;
import org.mxupdate.update.util.AdminPropertyList_mxJPO.AdminProperty;

/**
 * Parses the update format for {@link PackageCI_mxJPO}. */
public class PackageParser
    extends AbstractParser_mxJPO<PackageCI_mxJPO>
{
}
PARSER_END(PackageParser)<DEFAULT> SKIP :
{
    " "
|   "\r"
|   "\t"
|   "\n"
}

<DEFAULT> TOKEN : /** first level */
{
      <DESCRIPTION:                         "description">                                  : STRING_EXPECTED

    | <HIDDEN_TRUE:                         "hidden">
    | <HIDDEN_FALSE:                        "!hidden">

    | <CUSTOM_TRUE:                         "custom">
    | <CUSTOM_FALSE:                        "!custom">

    | <USESPACKAGE:                         "usespackage">                                  : STRING_EXPECTED

}

/************************************************************** Common String */
<STRING_EXPECTED> SKIP :
{
    " " | "\t" | "\n" | "\r"
}

<STRING_EXPECTED> TOKEN :
{
      <STRING: (<APOSTROPHE>(<CHAR> | "\\\"" | "{" | "}" | " ")*<APOSTROPHE>)> : DEFAULT
    | <SINGLE: (<CHAR>)+> : DEFAULT
    | <#APOSTROPHE: "\"" >
    | <#CHAR: ~["\u0000"-"\u0020","\"","{","}","\u0100"-"\uffff"]>
}

/********************************************************************* Member */
<DEFAULT> TOKEN :
{
      <MEMBER:                              "member">                                       : MEMBERREF_EXPECTED
}

<MEMBERREF_EXPECTED> SKIP :
{
    " " | "\t" | "\n" | "\r"
}

<MEMBERREF_EXPECTED> TOKEN :
{
      <MEMBERTYPE_STRING : (<MEMBERTYPE_APOSTROPHE>(<MEMBERTYPE_CHAR> | "\\\"" | "{" | "}" | " ")*<MEMBERTYPE_APOSTROPHE>)> : STRING_EXPECTED
    | <MEMBERTYPE_SINGLE : (<MEMBERTYPE_CHAR>)+> : STRING_EXPECTED
    | <#MEMBERTYPE_APOSTROPHE : "\"" >
    | <#MEMBERTYPE_CHAR : ~["\u0000"-"\u0020","\"","{","}","\u0100"-"\uffff"]>
}

/******************************************************************* Property */
<DEFAULT> TOKEN :
{
      <PROPERTY:                            "property">                                     : STRING_EXPECTED
    | <PROPERTYTO:                          "to">                                           : ADMINREF_EXPECTED
    | <PROPERTYVAL:                         "value">                                        : STRING_EXPECTED
}

<ADMINREF_EXPECTED> SKIP :
{
    " " | "\t" | "\n" | "\r"
}

<ADMINREF_EXPECTED> TOKEN :
{
      <ADMINTYPE_STRING : (<ADMINTYPE_APOSTROPHE>(<ADMINTYPE_CHAR> | "\\\"" | "{" | "}" | " ")*<ADMINTYPE_APOSTROPHE>)> : STRING_EXPECTED
    | <ADMINTYPE_SINGLE : (<ADMINTYPE_CHAR>)+> : STRING_EXPECTED
    | <#ADMINTYPE_APOSTROPHE : "\"" >
    | <#ADMINTYPE_CHAR : ~["\u0000"-"\u0020","\"","{","}","\u0100"-"\uffff"]>
}

/**************************************************************************** */
/**
 * Parses one complete package definition.
 *
 * @param _package      target package to update with parsed values
 */
void parse(final PackageCI_mxJPO _package)
    throws SecurityException, IllegalArgumentException, NoSuchMethodException, InstantiationException, IllegalAccessException, InvocationTargetException
: {
    Token tmp;
    MemberRef member;
    AdminProperty property;
} {
    (   ( <DESCRIPTION>             ( tmp = <STRING>                        {this.setValue(_package, "description",                    this.getString(tmp.image));}
                                    | tmp = <SINGLE>                        {this.setValue(_package, "description",                    this.getSingle(tmp.image));} ) )

      | ( <HIDDEN_TRUE>                                                     {this.setValue(_package, "hidden",                         true);} )
      | ( <HIDDEN_FALSE>                                                    {this.setValue(_package, "hidden",                         false);} )

      | ( <CUSTOM_TRUE>                                                     {this.setValue(_package, "custom",                         true);} )
      | ( <CUSTOM_FALSE>                                                    {this.setValue(_package, "custom",                         false);} )

      | ( <USESPACKAGE>             ( tmp = <STRING>                        {this.appendValue(_package, "usesPackages",                this.getString(tmp.image));}
                                    | tmp = <SINGLE>                        {this.appendValue(_package, "usesPackages",                this.getSingle(tmp.image));} ) )


      | ( <MEMBER>                                                          {member = new MemberRef();this.appendValue(_package, "members", member);}
                    ( tmp = <MEMBERTYPE_STRING>                             {this.setValue(member, "refAdminType",                      this.getString(tmp.image));}
                    | tmp = <MEMBERTYPE_SINGLE>                             {this.setValue(member, "refAdminType",                      this.getSingle(tmp.image));} )
                                    ( tmp = <STRING>                        {this.setValue(member, "refAdminName",                      this.getString(tmp.image));}
                                    | tmp = <SINGLE>                        {this.setValue(member, "refAdminName",                      this.getSingle(tmp.image));} ) )

      | ( <PROPERTY>                                                        {property = new AdminProperty();this.appendValue(_package, "properties", "propertiesStack", property);}
                                    ( tmp = <STRING>                        {this.setValue(property, "name", this.getString(tmp.image));}
                                    | tmp = <SINGLE>                        {this.setValue(property, "name", this.getSingle(tmp.image));} )
              (   ( <PROPERTYVAL>   ( tmp = <STRING>                        {this.setValue(property, "value", this.getString(tmp.image));}
                                    | tmp = <SINGLE>                        {this.setValue(property, "value", this.getSingle(tmp.image));} ) )
                | ( <PROPERTYTO>    ( tmp = <ADMINTYPE_STRING>              {this.setValue(property, "refAdminType", this.getString(tmp.image));}
                                    | tmp = <ADMINTYPE_SINGLE>              {this.setValue(property, "refAdminType", this.getSingle(tmp.image));} )
                                    ( tmp = <STRING>                        {this.setValue(property, "refAdminName", this.getString(tmp.image));}
                                    | tmp = <SINGLE>                        {this.setValue(property, "refAdminName", this.getSingle(tmp.image));} ) ) )* )
    )*
}
